{{- $source := $.Get "src" -}}
{{- if not $source -}}
  {{- errorf "Video 'src' must be supplied" -}}
{{- end -}}
{{- $video := or ($.Page.Resources.GetMatch $source) (resources.GetMatch $source) -}}
{{- $type := $.Get "type" -}}
{{- if $video -}}
  {{- $type = $type | default $video.MediaType.Type -}}
{{- end -}}
{{- if not $type -}}
  {{- errorf "Video 'type' must be supplied" -}}
{{- end -}}
{{- $caption := $.Get "caption" -}}
{{- $preload := $.Get "preload" | default "metadata" -}}
{{- $ops := $.Get "ops" | default "" -}}
{{- $poster := $.Get "poster" | default "" -}}
{{- $width := $.Get "width" | default "100%" -}}
{{- $anchor := $.Get "anchor" | default "center" -}}
{{- $wrap := $.Get "wrap" | default "false" -}}

{{- $style := printf "width: %s;" $width -}}
{{- if eq $wrap "true" -}}
  {{- if eq $anchor "left" -}}
    {{- $style = printf "%s float: left; margin: 0 1rem 0.7rem 0;" $style -}}
  {{- else if eq $anchor "right" -}}
    {{- $style = printf "%s float: right; margin: 0 0 0.7rem 1rem;" $style -}}
  {{- else -}}
    {{- $style = printf "%s margin: 0 auto;" $style -}}
  {{- end -}}
{{- else -}}
  {{- if eq $anchor "left" -}}
    {{- $style = printf "%s margin-right: auto;" $style -}}
  {{- else if eq $anchor "right" -}}
    {{- $style = printf "%s margin-left: auto;" $style -}}
  {{- else -}}
    {{- $style = printf "%s margin: 0 auto;" $style -}}
  {{- end -}}
{{- end -}}

{{ printf `<div class="video-container" style="%s">` $style | safeHTML }}
{{- if $caption -}}
<figure>
{{- end -}}
{{- if $poster -}}
  {{ printf `<video preload="%s" poster="%s" %s>` $preload $poster $ops | safeHTML }}
{{- else -}}
  {{ printf `<video preload="%s" %s>` $preload $ops | safeHTML }}
{{- end -}}
    <source
      src="{{ with $video }}{{ .RelPermalink }}{{ else }}{{ $source }}{{ end }}"
      type="{{ $type }}"
    >
    Your browser does not support the video element.
  </video>
{{- with $caption -}}
  <figcaption>{{ . | markdownify }}</figcaption>
</figure>
{{- end -}}
</div>
